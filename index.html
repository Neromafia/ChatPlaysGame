<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa Hàng Vật Phẩm</title>
    <style>
        /* CSS Đơn giản để trang web dễ nhìn */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.5em;
        }
        .step {
            padding: 20px;
        }
        h2 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            color: #007bff;
        }
        
        /* Giai đoạn 1: Chọn Shop */
        #shop-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .shop-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .shop-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.2);
            transform: translateY(-2px);
        }
        .item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }
        .item-price {
            color: #d9534f;
            font-weight: bold;
            font-size: 1.2em;
            margin-top: 5px;
        }

        /* Giai đoạn 2: Nhập ID */
        #user-input-container {
            display: none; /* Ẩn ban đầu */
        }
        #summary-box {
            background-color: #f9f9f9;
            border: 1px dashed #ccc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .summary-row span:first-child { font-weight: bold; }
        .summary-row span:last-child { font-weight: bold; color: #d9534f; }
        
        input[type="text"] {
            width: 95%;
            padding: 12px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .warning {
            color: #d9534f;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        /* Giai đoạn 3: Mã QR */
        #qr-container {
            display: none; /* Ẩn ban đầu */
            text-align: center;
        }
        #qr-image {
            width: 250px;
            height: 250px;
            border: 2px solid #007bff;
            border-radius: 8px;
        }
        #qr-info {
            background-color: #f0f2f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            font-weight: bold;
            word-break: break-all;
        }

        /* Nút */
        .button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
        }
        .button-secondary {
            background-color: #6c757d;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

    </style>
</head>
<body>

    <div class="container">
        
        <div id="step1-shop" class="step">
            <div class="header">Cửa Hàng (Giai đoạn 1)</div>
            <h2>1. Vui lòng chọn gói nạp</h2>
            <div id="shop-container">
                </div>
        </div>

        <div id="step2-user-input" class="step" style="display: none;">
            <div class="header">Xác Nhận (Giai đoạn 2)</div>
            <h2>2. Nhập ID TikTok của bạn</h2>

            <div id="summary-box">
                <div class="summary-row">
                    <span>Gói đã chọn:</span>
                    <span id="summary-name"></span>
                </div>
                <div class="summary-row">
                    <span>Thanh toán:</span>
                    <span id="summary-price"></span>
                </div>
            </div>
            
            <label for="tiktok-id">ID TikTok (Không bao gồm @)</label>
            <input type="text" id="tiktok-id" placeholder="ví dụ: user123">
            
            <p class="warning">
                ⚠️ VUI LÒNG KIỂM TRA LẠI ID! NẾU BẠN GÕ SAI, VẬT PHẨM SẼ BỊ GỬI NHẦM VÀ CHÚNG TÔI KHÔNG CHỊU TRÁCH NHIEM!
            </p>
            
            <button class="button" onclick="generateQR()">Tạo Mã QR</button>
            <button class="button button-secondary" onclick="goBackToShop()">Chọn lại gói</button>
        </div>

        <div id="step3-qr" class="step" style="display: none;">
            <div class="header">Thanh Toán (Giai đoạn 3)</div>
            <h2>3. Quét mã VietQR để hoàn tất</h2>
            <p>Sử dụng App Ngân hàng để quét. Vật phẩm sẽ được gửi sau 1-2 phút.</p>
            
            <img id="qr-image" src="" alt="Đang tạo mã QR...">
            
            <div id="qr-info">
                Nội dung chuyển khoản (Tự động):<br>
                <span id="qr-content"></span>
            </div>
            
            <button class="button button-secondary" onclick="startOver()">Hoàn tất (Nạp gói khác)</button>
        </div>

    </div>

    <script>
        // ========== 1. CẤU HÌNH SHOP VÀ NGÂN HÀNG ==========
        
        // Thông tin ngân hàng của bạn
        const BANK_INFO = {
            BANK_ID: "970423",     // BIN của TPBank
            ACCOUNT_NO: "88942689999" // STK của bạn
        };

        // Danh sách vật phẩm (Lấy từ PRICE_MAP và get_item_details của bạn)
        const SHOP_ITEMS = [
            { sku: 'BOX1', name: 'Gói 1 Box', price: 5000 },
            { sku: 'KEY1', name: 'Gói 1 Key', price: 10000 },
            { sku: 'GOI1', name: 'Gói 1 Key + 1 Box', price: 13000 },
            { sku: 'NHANDOI', name: 'Vé X2 Thưởng', price: 30000 },
            { sku: 'EXP1NGAY', name: 'EXP Boost (1 Ngày)', price: 30000 },
            { sku: 'BAOHIEM', name: 'Bảo hiểm Vote (VIP)', price: 50000 },
            { sku: 'KEY2', name: 'Gói 6 Keys', price: 50000 },
            { sku: 'GOI2', name: 'Gói 4 Keys + 4 Boxes', price: 50000 },
            { sku: 'EXP3NGAY', name: 'EXP Boost (3 Ngày)', price: 60000 },
            { sku: 'KEY3', name: 'Gói 13 Keys', price: 100000 },
            { sku: 'GOI3', name: 'Gói 8 Keys + 8 Boxes', price: 100000 },
            { sku: 'EXP7NGAY', name: 'EXP Boost (7 Ngày)', price: 120000 },
        ];

        // Biến tạm để lưu lựa chọn
        let selectedItem = null;

        // ========== 2. CÁC HÀM XỬ LÝ ==========

        // Tự động tạo danh sách shop khi tải trang
        window.onload = function() {
            const shopContainer = document.getElementById('shop-container');
            
            SHOP_ITEMS.forEach(item => {
                // Định dạng giá tiền cho đẹp
                const formattedPrice = item.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                
                // Tạo 1 thẻ item
                const itemHTML = `
                    <div class="shop-item" onclick="selectItem('${item.sku}', ${item.price}, '${item.name}')">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">${formattedPrice}</div>
                    </div>
                `;
                shopContainer.innerHTML += itemHTML;
            });
        };

        // Khi người dùng CHỌN 1 vật phẩm
        function selectItem(sku, price, name) {
            selectedItem = { sku, price, name }; // Lưu lại
            
            // Cập nhật tóm tắt
            document.getElementById('summary-name').innerText = name;
            document.getElementById('summary-price').innerText = price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });

            // Ẩn Giai đoạn 1, Hiển thị Giai đoạn 2
            document.getElementById('step1-shop').style.display = 'none';
            document.getElementById('step2-user-input').style.display = 'block';
            document.getElementById('tiktok-id').focus();
        }

        // Khi người dùng nhấn nút "Tạo Mã QR"
        function generateQR() {
            const tiktokIdInput = document.getElementById('tiktok-id');
            let tiktokId = tiktokIdInput.value;

            // 1. Kiểm tra ID
            if (!tiktokId) {
                alert('Vui lòng nhập ID TikTok!');
                tiktokIdInput.focus();
                return;
            }

            // 2. Xử lý ID (Xóa @, xóa cách, chuyển thành chữ HOA)
            // (Giống logic server Python của bạn để đảm bảo trùng khớp)
            tiktokId = tiktokId.replace('@', '').trim().toUpperCase();

            // 3. Tạo nội dung chuyển khoản (Rất quan trọng)
            // Phải khớp với cú pháp server Python mong đợi: SKU<dấu cách>USERNAME
            const addInfo = `${selectedItem.sku} ${tiktokId}`;
            
            // 4. Tạo URL cho API VietQR
            const amount = selectedItem.price;
            const vietQR_API_URL = "https://api.vietqr.io/v2/generate";
            
            // Dùng encodeURIComponent để mã hóa nội dung (ví dụ: "KEY1 USER123" -> "KEY1%20USER123")
            const fullURL = `${vietQR_API_URL}?acqId=${BANK_INFO.BANK_ID}&accountNo=${BANK_INFO.ACCOUNT_NO}&amount=${amount}&addInfo=${encodeURIComponent(addInfo)}`;

            // 5. Hiển thị mã QR
            document.getElementById('qr-image').src = fullURL;
            document.getElementById('qr-content').innerText = addInfo; // Hiển thị nội dung cho user kiểm tra

            // Ẩn Giai đoạn 2, Hiển thị Giai đoạn 3
            document.getElementById('step2-user-input').style.display = 'none';
            document.getElementById('step3-qr').style.display = 'block';
        }

        // Quay lại chọn gói
        function goBackToShop() {
            document.getElementById('step1-shop').style.display = 'block';
            document.getElementById('step2-user-input').style.display = 'none';
            selectedItem = null; // Xóa lựa chọn
        }

        // Bắt đầu lại từ đầu
        function startOver() {
            document.getElementById('step1-shop').style.display = 'block';
            document.getElementById('step3-qr').style.display = 'none';
            selectedItem = null;
            document.getElementById('tiktok-id').value = '';
            document.getElementById('qr-image').src = '';
            document.getElementById('qr-content').innerText = '';
        }

    </script>
</body>
</html>